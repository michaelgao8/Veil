Veil: Deidentify data
======================

Veil is a collection of utilities to help deidentify datasets. Currently, the main purpose of Veil is to provide 
an easy way to create a reference table for an ID column that is sensitive and to map it to any number of downstream
dataframes. Veil relies on `Pandas` to do most of the heavy lifting, and simply provides a way to concisely deidentify
and reidentify columns where necessary. 

TODO:
* Enumerate current issues (ID column collisions, etc.)
* Provide more saving formats for `id_veil.save()`
* Add tests
* Add Age deidentification (remove all encounters which span 90 years old)

Usage
=====


The usage of this utility, as of the current version, utilizes `.yml` files to configure the deidentification. 

### Step 1: Generate Configuration File

The first step is to locate the directory which contains the `.csv` files that you wish to deidentify. 
From the Veil folder, run `python init_yml.py -i [directory that contains input files]`

To view more options, you can run `python init_yml.py --help`

This step generates a file called `veil.yml`. 

### Step 2: Fill out the `.yml` configuration

The next step is then to fill out this file, as this is where
the configuration for the deidentification is specified. 

These instructions are outlined below and also in the file
#### Initial Configuration generated by Veil.py
#### Background:

```
As part of the process of using Veil to de-identify files, you as the user 
will need to specify some parameters so that Veil can figure out the best 
way to de-deidentify your data. Any field that is marked #TODO# needs to
be completed by the user before this configuration is valid
```

#### Time Offset Method
```
There are two ways of offsetting dates in Veil. Random takes a random number
of days, and shifts all dates in a dataset by that amount. You can modify 
the max days below. The year_start method will be implemented in a future 
version of veil. 
```

#### Example:
```
time_offset_method: random
max_days: 365
```

#### Column Aliases
```
Occassionally, there will be files that have different column names
that actually refer to the same thing. You will need to specify them 
below. 
```
#### Example:

```
alias1:
  - pat_id
  - PATIENT_ID
  - patient_id
  - patient_num
```

An important note: the name of the group MUST begin with the word alias,
as this is how Veil finds it in this configuration:

#### Columns to deidentify
```
Below is an auto-generated list for every .csv file in this directory.
After each filename are two lists, the first is a datetime list and 
second is an ID list. Within those lists, ALL column names are currently
populated. Please trim those down to only include the correct columns.
Datetime columns should be any columns which will need to be time shifted
ID columns are any columns which will need to be masked.
```


#### Datetime columns
```
Datetime columns need to be initialized with an ID column. For example,
You may choose to shift a date similarly for all rows with the same 
patient ID. To specify the correct column to base the datetime shifts on,
include it in the following configuration:
NOTE: Valid values include a column name or an alias name. 
```
#### Example:
```
datetime_base: PATIENT_ID
```

#### Columns

``` 
Veil will automatically generate the column names and place them in 3 categories: 
ID, Datetime, and Exclude. Remove columns until these match what you expect them to.

Any ID column should be put under the ID column, even if it has already been specified in an alias.
Any datetime column must be included in the datetime section
Any columns that need to be excluded must be included in the exclude section.
```

Disclaimer
----------

The deidentification of data is, by design, a process which must be carefully done by the end user. This 
utility provides NO guarantees that the data is actually de-identified. Although some testing will be added
to ensure some basic deidentification has occurred, *it is the sole responsibility of anyone using the above 
utility to ensure that all protected information has been properly removed*. For example, HIPAA identifiers 
include an age above 90, which this package DOES NOT currently support removing. In addition, the utility does 
not attempt to figure out which columns contain PHI. All specification is done by the user and thus the user 
assumes all responsibility for the quality of the deidentification process.

Protected Health Information (PHI)
----------------------------------

The de-identification criteria for protected health information in the United States is described [here](https://www.law.cornell.edu/cfr/text/45/164.514)

License
-------
MIT